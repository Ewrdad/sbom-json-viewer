import { describe, it, expect } from 'vitest';
import { calculateSbomStats } from './statsUtils';

describe('statsUtils Vulnerability Aggregation', () => {
    it('should correctly aggregate CWE counts', () => {
        const bom = {
            components: [],
            vulnerabilities: [
                { id: 'V1', cwes: [79, 89], ratings: [{ severity: 'high' }] },
                { id: 'V2', cwes: [79], ratings: [{ severity: 'medium' }] },
                { id: 'V3', cwes: [123], ratings: [{ severity: 'low' }] }
            ]
        };

        const stats = calculateSbomStats(bom);
        
        expect(stats.cweCounts['CWE-79']).toBe(2);
        expect(stats.cweCounts['CWE-89']).toBe(1);
        expect(stats.cweCounts['CWE-123']).toBe(1);
    });

    it('should correctly aggregate source counts from source name', () => {
        const bom = {
            components: [],
            vulnerabilities: [
                { id: 'V1', source: { name: 'nvd' }, ratings: [{ severity: 'high' }] },
                { id: 'V2', source: { name: 'NVD' }, ratings: [{ severity: 'medium' }] },
                { id: 'V3', source: { name: 'GitHub' }, ratings: [{ severity: 'low' }] }
            ]
        };

        const stats = calculateSbomStats(bom);
        
        expect(stats.sourceCounts['NVD']).toBe(2);
        expect(stats.sourceCounts['GITHUB']).toBe(1);
    });

    it('should correctly infer source from ID prefix', () => {
        const bom = {
            components: [],
            vulnerabilities: [
                { id: 'CVE-2024-001', ratings: [{ severity: 'high' }] },
                { id: 'GHSA-xxx', ratings: [{ severity: 'medium' }] },
                { id: 'CUSTOM-123', ratings: [{ severity: 'low' }] }
            ]
        };

        const stats = calculateSbomStats(bom);
        
        expect(stats.sourceCounts['NVD']).toBe(1);
        expect(stats.sourceCounts['GHSA']).toBe(1);
        expect(stats.sourceCounts['CUSTOM']).toBeUndefined(); // Should not infer unknown prefixes
    });

    it('should extract comprehensive vulnerability fields', () => {
        const bom = {
            components: [{ "bom-ref": "pkg1", name: "pkg", version: "1" }],
            vulnerabilities: [
                { 
                    id: 'CVE-1', 
                    workaround: 'Do this', 
                    credits: { individuals: [{ name: 'Jane' }] },
                    tools: [{ name: 'Scanner' }],
                    ratings: [{ severity: 'critical' }],
                    affects: [{ ref: 'pkg1' }]
                }
            ]
        };

        const stats = calculateSbomStats(bom);
        const v = stats.allVulnerabilities[0];
        
        expect(v.workaround).toBe('Do this');
        expect(v.credits?.individuals?.[0].name).toBe('Jane');
        expect(v.tools?.[0].name).toBe('Scanner');
        expect(v.affectedComponentRefs).toContain('pkg1');
    });
});
