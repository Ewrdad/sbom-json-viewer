import { describe, it, expect } from 'vitest';
import { calculateSbomStats } from './statsUtils';

describe('statsUtils Vulnerability Analysis (CycloneDX 1.7)', () => {
    it('should correctly parse comprehensive vulnerability fields', () => {
        const bom = {
            components: [
                { "bom-ref": "pkg1", name: "Package 1", version: "1.0.0" }
            ],
            vulnerabilities: [
                {
                    id: "CVE-2024-1234",
                    severity: "high",
                    description: "Test Description",
                    detail: "Test Detail",
                    recommendation: "Test Recommendation",
                    created: "2024-01-01T00:00:00Z",
                    published: "2024-01-02T00:00:00Z",
                    updated: "2024-01-03T00:00:00Z",
                    rejected: "2024-01-04T00:00:00Z",
                    analysis: {
                        state: "not_affected",
                        justification: "code_not_reachable",
                        response: ["will_not_fix"],
                        detail: "Analysis detail text"
                    },
                    affects: [
                        { ref: "pkg1" }
                    ],
                    cwes: [79, 89],
                    advisories: [
                        { title: "Advisory 1", url: "https://example.com/adv1" }
                    ],
                    ratings: [
                        { method: "CVSSv3", score: 8.5, severity: "high", vector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H" }
                    ],
                    proofOfConcept: {
                        reproductionSteps: "Steps to reproduce",
                        environment: "Test Environment"
                    }
                }
            ]
        };

        const stats = calculateSbomStats(bom);
        
        expect(stats.allVulnerabilities.length).toBe(1);
        const v = stats.allVulnerabilities[0];
        
        expect(v.id).toBe("CVE-2024-1234");
        expect(v.severity).toBe("high");
        expect(v.description).toBe("Test Description");
        expect(v.detail).toBe("Test Detail");
        expect(v.recommendation).toBe("Test Recommendation");
        expect(v.created).toBe("2024-01-01T00:00:00Z");
        expect(v.published).toBe("2024-01-02T00:00:00Z");
        expect(v.updated).toBe("2024-01-03T00:00:00Z");
        expect(v.rejected).toBe("2024-01-04T00:00:00Z");
        expect(v.analysis?.state).toBe("not_affected");
        expect(v.analysis?.justification).toBe("code_not_reachable");
        expect(v.analysis?.response).toContain("will_not_fix");
        expect(v.cwes).toContain(79);
        expect(v.cwes).toContain(89);
        expect(v.affectedComponentRefs).toContain("pkg1");
        expect(v.proofOfConcept?.reproductionSteps).toBe("Steps to reproduce");
    });

    it('should correctly aggregate affected components across multiple components', () => {
        const bom = {
            components: [
                { "bom-ref": "pkg1", name: "Package 1", version: "1.0.0" },
                { "bom-ref": "pkg2", name: "Package 2", version: "2.0.0" }
            ],
            vulnerabilities: [
                {
                    id: "CVE-SHARED",
                    severity: "medium",
                    affects: [
                        { ref: "pkg1" },
                        { ref: "pkg2" }
                    ]
                }
            ]
        };

        const stats = calculateSbomStats(bom);
        const v = stats.allVulnerabilities.find(vl => vl.id === "CVE-SHARED");
        
        expect(v?.affectedCount).toBe(2);
        expect(v?.affectedComponentRefs).toContain("pkg1");
        expect(v?.affectedComponentRefs).toContain("pkg2");
    });
});
