import { render, screen, fireEvent, act } from '@testing-library/react';
import { VulnerabilityRawJson } from './VulnerabilityRawJson';
import { describe, it, expect, vi, beforeEach } from 'vitest';

// Mock the clipboard API
const mockClipboard = {
  writeText: vi.fn(),
};
Object.defineProperty(navigator, 'clipboard', {
  value: mockClipboard,
  writable: true,
});

describe('VulnerabilityRawJson', () => {
  const mockVuln = {
    id: 'CVE-2024-001',
    _raw: {
      id: 'CVE-2024-001',
      description: 'Original raw description'
    }
  };

  const mockMultiVuln = {
    id: 'CVE-2024-001',
    _rawSources: [
      { name: 'Source 1', json: { id: 'CVE-2024-001', note: 'From Source 1' } },
      { name: 'Source 2', json: { id: 'CVE-2024-001', note: 'From Source 2' } }
    ]
  };

  beforeEach(() => {
    vi.clearAllMocks();
    vi.useFakeTimers();
  });

  it('should not render anything if no raw data is present', () => {
    const { container } = render(<VulnerabilityRawJson v={{ id: 'test' }} />);
    expect(container.firstChild).toBeNull();
  });

  it('should render trigger when raw data is present', () => {
    render(<VulnerabilityRawJson v={mockVuln} />);
    expect(screen.getByText('View Raw JSON')).toBeInTheDocument();
  });

  it('should show raw JSON when trigger is clicked', () => {
    render(<VulnerabilityRawJson v={mockVuln} />);
    fireEvent.click(screen.getByText('View Raw JSON'));
    
    // Check if the raw description is present
    expect(screen.getByText(/"Original raw description"/)).toBeInTheDocument();
  });

  it('should show source selector when multiple sources are present', () => {
    render(<VulnerabilityRawJson v={mockMultiVuln} />);
    fireEvent.click(screen.getByText('View Raw JSON'));
    
    // The source selector should be present (SelectTrigger)
    expect(screen.getByTestId('vuln-source-selector')).toBeInTheDocument();
  });

  it('should copy JSON to clipboard when copy button is clicked', async () => {
    render(<VulnerabilityRawJson v={mockVuln} />);
    
    const copyBtn = screen.getByTitle('Copy JSON');
    fireEvent.click(copyBtn);

    expect(mockClipboard.writeText).toHaveBeenCalledWith(
      JSON.stringify(mockVuln._raw, null, 2)
    );

    // Should show check icon
    expect(screen.queryByTitle('Copy JSON')?.querySelector('svg')).toBeDefined();
    
    // Fast-forward timers to reset copy icon
    act(() => {
      vi.advanceTimersByTime(2000);
    });
  });

  it('should use cleanSbomMetadata as fallback if _raw is missing', () => {
    const vulnNoRaw = {
      id: 'CVE-TEST',
      _rawSources: [{ name: 'S1', json: { id: 'CVE-TEST' } }]
    };
    render(<VulnerabilityRawJson v={vulnNoRaw} />);
    fireEvent.click(screen.getByText('View Raw JSON'));
    
    // In this case, activeTab is 'combined' by default, 
    // and since _raw is missing, it should use cleanSbomMetadata(v)
    expect(screen.getByText(/"CVE-TEST"/)).toBeInTheDocument();
  });
});
