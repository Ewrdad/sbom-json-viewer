import { ExternalLink } from 'lucide-react';
import { cn } from "@/lib/utils";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";

interface VulnerabilityLinkProps {
  id: string;
  className?: string;
  showIcon?: boolean;
  children?: React.ReactNode;
}

export function VulnerabilityLink({ id, className, showIcon = false, children }: VulnerabilityLinkProps) {
  const getLink = (id: string) => {
    const cleanId = id.trim().toUpperCase();
    if (cleanId.startsWith('CWE-')) {
      const cweId = cleanId.replace('CWE-', '');
      return `https://cwe.mitre.org/data/definitions/${cweId}.html`;
    }
    if (cleanId.startsWith('CVE-')) {
      return `https://nvd.nist.gov/vuln/detail/${cleanId}`;
    }
    if (cleanId.startsWith('GHSA-')) {
      return `https://github.com/advisories/${cleanId}`;
    }
    return null;
  };

  const url = getLink(id);

  if (!url) {
    return <span className={className} data-testid="vulnerability-link">{children || id}</span>;
  }

  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger asChild>
          <a
            href={url}
            target="_blank"
            rel="noopener noreferrer"
            className={cn("hover:underline inline-flex items-center gap-1", className)}
            data-testid="vulnerability-link"
          >
            {children || id}
            {showIcon && <ExternalLink className="h-3 w-3" />}
          </a>
        </TooltipTrigger>
        <TooltipContent>
          <p className="text-[10px] max-w-[200px]">
            External link: shares the ID with {(() => {
              try {
                return new URL(url).hostname;
              } catch {
                return 'external source';
              }
            })()} for lookup.
          </p>
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
}
