import {
  ShieldCheck,
  AlertTriangle,
} from "lucide-react";

const SEVERITY_COLORS = {
  Critical: "#dc2626",
  High: "#ea580c",
  Medium: "#ca8a04",
  Low: "#2563eb",
  None: "#16a34a",
};

const getSeverityColor = (sev?: string) => {
  if (!sev) return SEVERITY_COLORS.None;
  try {
    const normalized = sev.charAt(0).toUpperCase() + sev.slice(1).toLowerCase();
    return SEVERITY_COLORS[normalized as keyof typeof SEVERITY_COLORS] || SEVERITY_COLORS.None;
  } catch {
    return SEVERITY_COLORS.None;
  }
};

/**
 * A hidden component designed specifically for A4 exports (PDF/PNG).
 * It unconditionally renders all details without accordions or scroll areas.
 */
export function VulnerabilityPrintView({
  vulnerability: v,
  allVulnerableComponents,
}: {
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  vulnerability: any;
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  allVulnerableComponents: any[];
}) {
  if (!v) return null;

  return (
    <div
      id="vulnerability-print-view"
      className="bg-white text-black p-8 font-sans"
      style={{
        width: "210mm",
        minHeight: "297mm",
        position: "absolute",
        top: 0,
        left: 0,
        opacity: 0,
        pointerEvents: "none",
        zIndex: -1,
      }}
    >
      {/* Header */}
      <div className="border-b-2 border-gray-200 pb-6 mb-6">
        <div className="flex items-center justify-between">
          <div>
            <div className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">
              Vulnerability Report
            </div>
            <div className="text-3xl font-black font-mono text-red-600 flex items-center gap-2">
              {v.id}
            </div>
          </div>
          <div className="text-right">
            <div className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">
              Severity
            </div>
            <div
              className="text-white py-1.5 px-4 rounded font-bold text-lg shadow-sm inline-block"
              style={{ backgroundColor: getSeverityColor(v.severity) }}
            >
              {v.severity}
            </div>
          </div>
        </div>
      </div>

      {/* 1. Overview */}
      <div className="mb-8">
        <h3 className="text-xl font-bold flex items-center gap-2 mb-4 text-gray-800 border-b pb-2">
          Overview
        </h3>
        {v.description && (
          <div className="mb-4">
            <h4 className="text-sm font-bold text-gray-600 uppercase mb-1">Description</h4>
            <div className="text-base leading-relaxed whitespace-pre-wrap text-gray-800">
              {v.description}
            </div>
          </div>
        )}
        
        {v.detail && v.description !== v.detail && (
          <div className="mb-4">
            <h4 className="text-sm font-bold text-gray-600 uppercase mb-1">In-Depth Analysis</h4>
            <div className="text-sm leading-relaxed whitespace-pre-wrap text-gray-700 bg-gray-50 p-4 rounded border">
              {v.detail}
            </div>
          </div>
        )}

        {v.cwes && v.cwes.length > 0 && (
          <div className="mb-4">
            <h4 className="text-sm font-bold text-gray-600 uppercase mb-2">CWE Classification</h4>
            <div className="flex flex-wrap gap-2">
              {v.cwes.map((cwe: number) => (
                <span key={cwe} className="font-mono text-xs py-1 px-3 border rounded bg-gray-100 text-gray-700">
                  CWE-{cwe}
                </span>
              ))}
            </div>
          </div>
        )}
      </div>

      {/* 2. Technical Details / Ratings */}
      {v.ratings && v.ratings.length > 0 && (
        <div className="mb-8 page-break-inside-avoid">
          <h3 className="text-xl font-bold flex items-center gap-2 mb-4 text-gray-800 border-b pb-2">
            Scoring & Ratings
          </h3>
          <div className="grid grid-cols-2 gap-4">
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            {v.ratings.map((rating: any, i: number) => (
              <div key={i} className="p-4 bg-gray-50 rounded border border-gray-200">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-xs font-bold uppercase text-gray-500">
                    {rating.method || "Score"}
                  </span>
                  <span
                    className="text-xs font-bold px-2 py-0.5 rounded border"
                    style={{
                      borderColor: getSeverityColor(rating.severity),
                      color: getSeverityColor(rating.severity),
                    }}
                  >
                    {rating.severity}
                  </span>
                </div>
                <div className="text-2xl font-black text-gray-900">{rating.score}</div>
                {rating.vector && (
                  <div className="text-[10px] font-mono text-gray-500 mt-2 break-all">
                    {rating.vector}
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      )}

      {/* 3. Remediation */}
      {(v.recommendation || v.workaround) && (
        <div className="mb-8 page-break-inside-avoid">
          <h3 className="text-xl font-bold flex items-center gap-2 mb-4 text-gray-800 border-b pb-2">
            Remediation & Evidence
          </h3>
          {v.recommendation && (
            <div className="mb-4">
              <h4 className="text-sm font-bold text-emerald-700 uppercase mb-2 flex items-center gap-2">
                <ShieldCheck className="h-4 w-4" /> Recommendation
              </h4>
              <div className="p-4 bg-emerald-50 border border-emerald-200 rounded text-sm leading-relaxed text-gray-800">
                {v.recommendation}
              </div>
            </div>
          )}
          {v.workaround && (
            <div className="mb-4">
              <h4 className="text-sm font-bold text-amber-600 uppercase mb-2 flex items-center gap-2">
                <AlertTriangle className="h-4 w-4" /> Workaround
              </h4>
              <div className="p-4 bg-amber-50 border border-amber-200 rounded text-sm leading-relaxed text-gray-800">
                {v.workaround}
              </div>
            </div>
          )}
        </div>
      )}

      {/* 4. Affected Components */}
      {v.affectedCount > 0 && (
        <div className="mb-8">
          <h3 className="text-xl font-bold flex items-center gap-2 mb-4 text-gray-800 border-b pb-2">
            Affected Components ({v.affectedCount})
          </h3>
          <div className="space-y-3">
            {allVulnerableComponents
              .filter((c) => v.affectedComponentRefs?.includes(c.ref))
              // eslint-disable-next-line @typescript-eslint/no-explicit-any
              .map((comp: any, i: number) => {
                const affect = v.affects?.find(
                  // eslint-disable-next-line @typescript-eslint/no-explicit-any
                  (a: any) => (a.ref?.value || a.ref) === comp.ref
                );
                const status = affect?.versions?.[0]?.status || "affected";

                return (
                  <div
                    key={i}
                    className="flex items-center justify-between p-3 rounded bg-gray-50 border border-gray-200 text-sm page-break-inside-avoid"
                  >
                    <div className="flex flex-col truncate pr-4 max-w-[70%]">
                      <span className="font-bold text-gray-900 truncate">
                        {comp.name}
                      </span>
                      <span className="text-xs text-gray-500 truncate font-mono mt-1">
                        {comp.ref}
                      </span>
                    </div>
                    <div className="flex items-center gap-2">
                      <span
                        className={`text-[10px] py-1 px-2 rounded uppercase font-bold text-white ${
                          status === "affected" ? "bg-red-600" : "bg-gray-500"
                        }`}
                      >
                        {status}
                      </span>
                      <span className="text-xs font-mono font-bold bg-white px-2 py-1 border rounded text-gray-700">
                        {comp.version}
                      </span>
                    </div>
                  </div>
                );
              })}
          </div>
        </div>
      )}

      {/* 5. Metadata */}
      <div className="mt-8 page-break-inside-avoid text-sm">
        <h3 className="text-xl font-bold flex items-center gap-2 mb-4 text-gray-800 border-b pb-2">
          Metadata Container
        </h3>
        <div className="grid grid-cols-2 gap-4 text-gray-700 bg-gray-50 p-4 rounded border border-gray-200">
          {v.source?.name && (
            <div>
              <span className="font-bold">Source:</span> {v.source.name}
              {v.source.url && <div className="text-xs text-blue-600 break-all mt-1">{v.source.url}</div>}
            </div>
          )}
          {v.created && (
            <div>
              <span className="font-bold">Created:</span> {new Date(v.created).toLocaleDateString()}
            </div>
          )}
          {v.published && (
            <div>
              <span className="font-bold">Published:</span> {new Date(v.published).toLocaleDateString()}
            </div>
          )}
          {v.updated && (
            <div>
              <span className="font-bold">Updated:</span> {new Date(v.updated).toLocaleDateString()}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
